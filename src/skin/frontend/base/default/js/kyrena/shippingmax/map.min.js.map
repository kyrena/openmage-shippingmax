{"version":3,"sources":["map.js"],"sourcesContent":["/**\n * Created V/12/04/2019\n * Updated M/07/12/2021\n *\n * Copyright 2019-2022 | Fabrice Creuzot <fabrice~cellublue~com>\n * Copyright 2019-2022 | Jérôme Siau <jerome~cellublue~com>\n * https://github.com/kyrena/openmage-shippingmax\n *\n * This program is free software, you can redistribute it or modify\n * it under the terms of the GNU General Public License (GPL) as published\n * by the free software foundation, either version 2 of the license, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but without any warranty, without even the implied warranty of\n * merchantability or fitness for a particular purpose. See the\n * GNU General Public License (GPL) for more details.\n */\n\nif (window.NodeList && !NodeList.prototype.forEach) {\n\tNodeList.prototype.forEach = function (callback, that, i) {\n\t\tthat = that || window;\n\t\tfor (i = 0; i < this.length; i++)\n\t\t\tcallback.call(that, this[i], i, this);\n\t};\n}\n\nvar shippingmax = new (function () {\n\n\t\"use strict\";\n\tthis.show    = false; // select country\n\tthis.showAll = false;\n\n\tthis.init = function () {\n\n\t\tconsole.info('shippingmax.map - hello');\n\n\t\t// voir aussi Kyrena_Shippingmax_Model_Source_Maps\n\t\t// pour self.defmap et pour les codes des cartes\n\t\tvar mkr, nb, elem, maps = {},\n\t\t    igncopy = '<a href=\"https://www.ign.fr/\" target=\"_blank\">IGN France<\\/a>',\n\t\t    osmcopy = '<a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">Open Street Map<\\/a>',\n\t\t    ggmcopy = '<a href=\"https://www.google.com/maps\" target=\"_blank\">Google<\\/a>',\n\t\t    config = {\n\t\t\tign: self.ignkey ? L.tileLayer('https://wxs.ign.fr/' + self.ignkey + '/geoportail/wmts?&request=GetTile&service=WMTS' +\n\t\t\t\t'&version=1.0.0&style=normal&tilematrixset=PM&format=image/jpeg&layer=GEOGRAPHICALGRIDSYSTEMS.MAPS' +\n\t\t\t\t'&tilematrix={z}&tilerow={y}&tilecol={x}', {\n\t\t\t\tattribution: igncopy,\n\t\t\t\tname: 'IGN France',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 18,\n\t\t\t\ttileSize: 256,\n\t\t\t\tdetectRetina: true\n\t\t\t}) : null,\n\t\t\tignst: self.ignkey ? L.tileLayer('https://wxs.ign.fr/' + self.ignkey + '/geoportail/wmts?&request=GetTile&service=WMTS' +\n\t\t\t\t'&version=1.0.0&style=normal&tilematrixset=PM&format=image/jpeg&layer=ORTHOIMAGERY.ORTHOPHOTOS' +\n\t\t\t\t'&tilematrix={z}&tilerow={y}&tilecol={x}', {\n\t\t\t\tattribution: igncopy,\n\t\t\t\tname: 'IGN Sat France',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 18,\n\t\t\t\ttileSize: 256,\n\t\t\t\tdetectRetina: true\n\t\t\t}) : null,\n\t\t\tosm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tosmfr: L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map France',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tosmde: L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map Deutschland',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tosmbre: L.tileLayer('https://tile.openstreetmap.bzh/br/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map Brezhoneg',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tosmoci: L.tileLayer('https://tile.openstreetmap.bzh/oc/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map Occitan',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tosmeus: L.tileLayer('https://tile.openstreetmap.bzh/eu/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map Euskara',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tosmbot: L.tileLayer('https://{s}.tile.openstreetmap.fr/openriverboatmap/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Street Map Boat',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tocm: L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: '<a href=\"https://github.com/cyclosm/cyclosm-cartocss-style\" target=\"_blank\">CyclOSM<\\/a>',\n\t\t\t\tname: 'Open Cyclo Map',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\totm: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {\n\t\t\t\tattribution: osmcopy,\n\t\t\t\tname: 'Open Topo Map',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tchm: L.tileLayer('https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg', {\n\t\t\t\tattribution: '<a href=\"https://www.swisstopo.admin.ch/\" target=\"_blank\">Swisstopo<\\/a>',\n\t\t\t\tname: 'Swiss Topo Map',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tggm: L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {\n\t\t\t\tsubdomains: ['mt0', 'mt1', 'mt2', 'mt3'],\n\t\t\t\tattribution: ggmcopy,\n\t\t\t\tname: 'Google Map',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t}),\n\t\t\tggmst: L.tileLayer('httpS://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {\n\t\t\t\tsubdomains: ['mt0', 'mt1', 'mt2', 'mt3'],\n\t\t\t\tattribution: ggmcopy,\n\t\t\t\tname: 'Google Map Sat',\n\t\t\t\tminZoom: 4,\n\t\t\t\tmaxZoom: 17,\n\t\t\t\tdetectRetina: true\n\t\t\t})\n\t\t};\n\n\t\tif (!config[self.defmap] || (self.defmap === 'ggm') && (['yes', '1', 1].indexOf(navigator.doNotTrack) > -1))\n\t\t\tself.defmap = 'osm';\n\n\t\t// charge les marqueurs\n\t\tself.grp = new L.featureGroup();\n\t\tthis.createMarkers(self.data);\n\n\t\t// charge les fonds de carte\n\t\tfor (elem in config) if (config.hasOwnProperty(elem)) {\n\t\t\tif (config[elem] && config[elem].options.name) {\n\t\t\t\tconfig[elem].options.attribution += ' ' + self.browser;\n\t\t\t\tmaps['<i class=\"hide\">' + elem + '<\\/i> ' + config[elem].options.name] = config[elem];\n\t\t\t}\n\t\t}\n\n\t\t// charge la carte\n\t\tnb = Object.keys(self.data).length;\n\t\tself.map = L.map('map', { layers: [config[self.defmap], self.grp], scrollWheelZoom: true, doubleRightClickZoom: true });\n\n\t\tif (nb < 1) {\n\t\t\tdocument.querySelector('div.main').classList.add('empty');\n\t\t}\n\t\telse if (nb > self.maxpts) {\n\t\t\tself.map.setView([46.76, 2.42], 6); // @todo France\n\t\t}\n\t\telse {\n\t\t\tself.map.fitBounds(self.grp.getBounds());\n\t\t\tif (self.map.getZoom() > 15)\n\t\t\t\tself.map.setZoom(15);\n\t\t}\n\n\t\tif (!document.querySelector('.alone')) {\n\t\t\tL.Control.Bigmap = L.Control.extend({\n\t\t\t\toptions: { position: 'topleft' },\n\t\t\t\tonAdd: function (map) {\n\t\t\t\t\tvar elem  = L.DomUtil.create('div', 'leaflet-control-fullscreen leaflet-bar leaflet-control');\n\t\t\t\t\tthis.link = L.DomUtil.create('a', 'leaflet-control-fullscreen-button leaflet-bar-part', elem);\n\t\t\t\t\tthis.link.href = '';\n\t\t\t\t\tthis._map = map;\n\t\t\t\t\tL.DomEvent.disableClickPropagation(this.link);\n\t\t\t\t\tL.DomEvent.on(this.link, 'click', this.action, this);\n\t\t\t\t\treturn elem;\n\t\t\t\t},\n\t\t\t\taction: function (ev) {\n\t\t\t\t\tL.DomEvent.stop(ev);\n\t\t\t\t\tif (ev.detail > 1)\n\t\t\t\t\t\treturn;\n\t\t\t\t\tvar btn = this.getContainer().classList, div = document.querySelector('.main').classList;\n\t\t\t\t\tif (btn.contains('leaflet-fullscreen-on')) {\n\t\t\t\t\t\tbtn.remove('leaflet-fullscreen-on');\n\t\t\t\t\t\tdiv.remove('full-map');\n\t\t\t\t\t\tif (div = document.querySelector('.item.clicked.active'))\n\t\t\t\t\t\t\tdiv.scrollIntoView();\n\t\t\t\t\t\telse if (div = document.querySelector('.item.clicked'))\n\t\t\t\t\t\t\tdiv.scrollIntoView();\n\t\t\t\t\t\telse if (div = document.querySelector('.item.active'))\n\t\t\t\t\t\t\tdiv.scrollIntoView();\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tbtn.add('leaflet-fullscreen-on');\n\t\t\t\t\t\tdiv.add('full-map');\n\t\t\t\t\t}\n\t\t\t\t\tthis._map.invalidateSize();\n\t\t\t\t}\n\t\t\t});\n\t\t\tself.map.addControl(new L.Control.Bigmap());\n\t\t}\n\n\t\tL.control.scale({ imperial: false }).addTo(self.map);\n\t\tL.control.layers(maps).addTo(self.map);\n\t\tself.grp.addTo(self.map);\n\n\t\t// marque l'éventuel point de livraison sélectionné\n\t\telem = document.querySelector('.item.active');\n\t\tif (elem) {\n\t\t\tmkr = self.mkrs[elem.getAttribute('id').slice(2)];\n\t\t\tmkr.getElement().classList.add('active');\n\t\t\tthis.goToDetailFromMarker({ target: mkr, move: false });\n\t\t}\n\n\t\t// si géoloc\n\t\telem = document.querySelector('.btn-geoloc');\n\t\tif (elem && navigator.geolocation)\n\t\t\telem.classList.remove('hide');\n\n\t\t// pour Edge 14 qui laisse le loader affiché\n\t\telem = self.parent.document.getElementById('shippingmaxBox');\n\t\tif (elem)\n\t\t\telem.classList.add('hack');\n\t};\n\n\tthis.geoloc = function () {\n\n\t\tif (navigator.geolocation) {\n\t\t\tvar elem = document.querySelector('.btn-geoloc span'), text = elem.textContent;\n\t\t\telem.textContent = '...';\n\t\t\tnavigator.geolocation.getCurrentPosition(function (position) {\n\t\t\t\tshippingmax.formAjax(document.querySelector('form.address'), position.coords.latitude, position.coords.longitude);\n\t\t\t\telem.textContent = text;\n\t\t\t}, function () {\n\t\t\t\telem.textContent = text;\n\t\t\t});\n\t\t}\n\t};\n\n\tthis.createMarkers = function (mkrs) {\n\n\t\tvar mkr, id;\n\t\tself.mkrs = {};\n\n\t\tfor (mkr in mkrs) if (mkrs.hasOwnProperty(mkr)) {\n\n\t\t\tmkr = mkrs[mkr];\n\t\t\tid  = mkr.id;\n\n\t\t\tmkr = L.marker([mkr.lat, mkr.lng], {\n\t\t\t\ttitle: mkr.name,\n\t\t\t\tshadowUrl: null,\n\t\t\t\tshadowRetinaUrl: null,\n\t\t\t\tshadowSize: null,\n\t\t\t\tshadowAnchor: null\n\t\t\t}).addTo(self.grp); //.bindPopup(mkr.name)\n\t\t\tmkr.on('click', shippingmax.goToDetailFromMarker);\n\t\t\tmkr.on('dblclick', L.DomEvent.stop);\n\t\t\tmkr.superId = id;\n\n\t\t\tself.mkrs[id] = mkr;\n\t\t}\n\n\t\tif ((self.marklat != 0) && (self.marklng != 0)) {\n\t\t\tL.marker([self.marklat, self.marklng], {\n\t\t\t\ticon: L.icon({\n\t\t\t\t\ticonUrl: L.Icon.Default.prototype._getIconUrl().replace('undefined', 'ic-user-map.svg'),\n\t\t\t\t\ticonSize: [26, 40],\n\t\t\t\t\ticonAnchor: [13, 25],\n\t\t\t\t\tshadowUrl: null,\n\t\t\t\t\tshadowRetinaUrl: null,\n\t\t\t\t\tshadowSize: null,\n\t\t\t\t\tshadowAnchor: null,\n\t\t\t\t\tclassName: 'userpos'\n\t\t\t\t})\n\t\t\t}).addTo(self.grp);\n\t\t}\n\t};\n\n\tthis.formAjax = function (form, lat, lng) {\n\n\t\tvar data, xhr = new XMLHttpRequest(), loader = document.getElementById('loader').classList;\n\n\t\ttry {\n\t\t\tif (!loader.contains('show')) {\n\n\t\t\t\tloader.add('show');\n\n\t\t\t\tif (shippingmax.showAll)\n\t\t\t\t\tshippingmax.showAll = false;\n\t\t\t\telse if ((typeof lat == 'number') && (typeof lng == 'number'))\n\t\t\t\t\tdata = shippingmax.serialize(form) + '&lat=' + lat + '&lng=' + lng + '&geoloc=1';\n\t\t\t\telse\n\t\t\t\t\tdata = shippingmax.serialize(form);\n\n\t\t\t\t// form update ou form save\n\t\t\t\tif (form.action.indexOf('update') > -1) {\n\t\t\t\t\tdocument.querySelector('form.results').innerHTML = '';\n\t\t\t\t\tdocument.activeElement.blur();\n\t\t\t\t}\n\n\t\t\t\tif (data) {\n\t\t\t\t\txhr.open('POST', (data.indexOf('id=') > -1) ? form.action + '?isAjax=true&' + data : form.action + '?isAjax=true', true);\n\t\t\t\t\txhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\txhr.open('GET', form.action + '?isAjax=true', true);\n\t\t\t\t}\n\n\t\t\t\txhr.onreadystatechange = function () {\n\n\t\t\t\t\tif ((xhr.readyState === 4) && ((xhr.status === 200) || (xhr.status === 0))) {\n\n\t\t\t\t\t\tvar mkr, elem, subelem, json, nb;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tjson = JSON.parse(xhr.responseText);\n\n\t\t\t\t\t\t\tif (json.status && json.maplist) {\n\n\t\t\t\t\t\t\t\t// update\n\t\t\t\t\t\t\t\tdocument.querySelector('form.results').innerHTML = json.maplist;\n\t\t\t\t\t\t\t\tself.data    = json.items;\n\t\t\t\t\t\t\t\tself.marklat = json.lat;\n\t\t\t\t\t\t\t\tself.marklng = json.lng;\n\n\t\t\t\t\t\t\t\tif (json.country && (elem = document.querySelector('input[value=\"' + json.country.toUpperCase() + '\"]'))) {\n\t\t\t\t\t\t\t\t\tif (subelem = document.querySelector('.country-choice input[checked]'))\n\t\t\t\t\t\t\t\t\t\tsubelem.removeAttribute('checked');\n\t\t\t\t\t\t\t\t\tif (subelem = document.querySelector('.country-choice input:checked'))\n\t\t\t\t\t\t\t\t\t\tsubelem.checked = false;\n\t\t\t\t\t\t\t\t\telem.checked = true;\n\t\t\t\t\t\t\t\t\telem.setAttribute('checked', 'checked');\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (json.postcode)\n\t\t\t\t\t\t\t\t\tdocument.getElementById('postcode').value = json.postcode;\n\t\t\t\t\t\t\t\tif (json.city)\n\t\t\t\t\t\t\t\t\tdocument.getElementById('city').value = json.city;\n\n\t\t\t\t\t\t\t\tself.grp.clearLayers();\n\t\t\t\t\t\t\t\tnb = Object.keys(self.data).length;\n\t\t\t\t\t\t\t\tif (nb > 0) {\n\t\t\t\t\t\t\t\t\tdocument.querySelector('div.main').classList.remove('empty');\n\t\t\t\t\t\t\t\t\tself.map.invalidateSize();\n\t\t\t\t\t\t\t\t\tshippingmax.createMarkers(self.data);\n\t\t\t\t\t\t\t\t\tif (nb > self.maxpts) {\n\t\t\t\t\t\t\t\t\t\tself.map.setView([46.76, 2.42], 6); // @todo France\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tself.map.fitBounds(self.grp.getBounds());\n\t\t\t\t\t\t\t\t\t\tif (self.map.getZoom() > 15)\n\t\t\t\t\t\t\t\t\t\t\tself.map.setZoom(15);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tdocument.querySelector('div.main').classList.add('empty');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (json.status) {\n\n\t\t\t\t\t\t\t\t// save\n\t\t\t\t\t\t\t\tif (typeof self.parent.shippingmax.show == 'function') {\n\t\t\t\t\t\t\t\t\tself.parent.shippingmax.show(json);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tshippingmax.reset(true);\n\t\t\t\t\t\t\t\t\tmkr = self.mkrs[json.id];\n\t\t\t\t\t\t\t\t\tmkr.getElement().classList.add('active');\n\t\t\t\t\t\t\t\t\tself.map.setView(mkr.getLatLng());\n\t\t\t\t\t\t\t\t\tdocument.getElementById('pt' + json.id).classList.add('active', 'clicked');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (json.error) {\n\t\t\t\t\t\t\t\tif (json.error === 'refresh')\n\t\t\t\t\t\t\t\t\tself.location.reload();\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\talert(json.error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\talert(json);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tloader.remove('show');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (e) {\n\t\t\t\t\t\t\tconsole.error(e, xhr.responseText); // SyntaxError: Unexpected end of JSON input\n\t\t\t\t\t\t\tself.location.reload();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\txhr.send(data);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\t\tcatch (e) {\n\t\t\tconsole.error(e);\n\t\t\tloader.remove('show');\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tthis.serialize = function (form) {\n\n\t\tvar data = [];\n\n\t\tArray.prototype.forEach.call(form.elements, function (elem) {\n\n\t\t\tif (elem.nodeName === 'INPUT') {\n\t\t\t\tif (['checkbox', 'radio'].indexOf(elem.getAttribute('type')) > -1) {\n\t\t\t\t\tif (elem.checked)\n\t\t\t\t\t\tdata.push(elem.name + '=' + encodeURIComponent(elem.value));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdata.push(elem.name + '=' + encodeURIComponent(elem.value));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (elem.nodeName === 'SELECT') {\n\t\t\t\tdata.push(elem.name + '=' + encodeURIComponent(elem.value));\n\t\t\t}\n\t\t});\n\n\t\treturn data.join('&');\n\t};\n\n\tthis.goToDetailFromMarker = function (ev) {\n\n\t\t// ne fait rien si formAjax est en cours\n\t\tif (document.activeElement && (document.activeElement.nodeName === 'BUTTON'))\n\t\t\treturn;\n\n\t\tvar mkr = ev.target, css = mkr.getElement().classList, already = css.contains('clicked');\n\t\tshippingmax.reset();\n\n\t\t// désélectionne ou sélectionne\n\t\tif (already) {\n\t\t\tcss.remove('clicked');\n\t\t}\n\t\telse {\n\t\t\tvar elem = document.getElementById('pt' + mkr.superId), form = document.querySelector('form.results');\n\n\t\t\tif (ev.move !== false) {\n\t\t\t\tcss.add('clicked');\n\t\t\t\telem.classList.add('clicked');\n\t\t\t\tself.map.setView(mkr.getLatLng());\n\t\t\t}\n\t\t\telse if (document.querySelector('.alone')) {\n\t\t\t\t// pour la carte d'une commande\n\t\t\t\tcss.add('clicked');\n\t\t\t\telem.classList.add('clicked');\n\t\t\t}\n\n\t\t\tif (form.scrollHeight > form.offsetHeight) {\n\t\t\t\tif (window.innerWidth < 992) {\n\t\t\t\t\tform.scrollTop = elem.offsetTop;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tform.scrollTop = elem.offsetTop - form.offsetHeight / 2 + 80;\n\t\t\t\t\tvar rect = elem.getBoundingClientRect();\n\t\t\t\t\tif ((rect.top < 0) && (rect.bottom <= window.innerHeight))\n\t\t\t\t\t\tform.scrollTop = elem.offsetTop;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.goToMarkerFromDetail = function (elem) {\n\n\t\t// ne fait rien si formAjax est en cours\n\t\tif (document.activeElement && (document.activeElement.nodeName === 'BUTTON'))\n\t\t\treturn;\n\n\t\tvar css = elem.classList, already = css.contains('clicked');\n\t\tthis.reset();\n\n\t\t// désélectionne ou sélectionne\n\t\tif (already) {\n\t\t\tcss.remove('clicked');\n\t\t}\n\t\telse {\n\t\t\tcss.add('clicked');\n\t\t\tvar mkr = self.mkrs[elem.getAttribute('id').slice(2)];\n\t\t\tmkr.getElement().classList.add('clicked');\n\t\t\tself.map.setView(mkr.getLatLng(), 15);\n\t\t}\n\t};\n\n\tthis.reset = function (active) {\n\t\tdocument.querySelectorAll('.clicked').forEach(function (elem) { elem.classList.remove('clicked'); });\n\t\tif (active)\n\t\t\tdocument.querySelectorAll('.active').forEach(function (elem) { elem.classList.remove('active'); });\n\t};\n\n\tthis.showSelect = function (action) {\n\t\taction = (action === false) ? 'remove' : ((this.show = !this.show) ? 'add' : 'remove');\n\t\tdocument.querySelector('.search-elements').classList[action]('country-select');\n\t\tthis.show = action === 'add';\n\t};\n\n\tthis.updatePostcode = function (elem) {\n\t\tdocument.getElementById('postcode').setAttribute('type', (self.tel.indexOf(elem.value) > -1) ? 'tel' : 'text');\n\t};\n\n})();\n\nif (typeof self.addEventListener == 'function')\n\tself.addEventListener('load', shippingmax.init.bind(shippingmax));"],"names":["window","NodeList","prototype","forEach","callback","that","i","this","length","call","shippingmax","show","showAll","init","console","info","elem","maps","igncopy","osmcopy","ggmcopy","config","ign","self","ignkey","L","tileLayer","attribution","name","minZoom","maxZoom","tileSize","detectRetina","ignst","osm","osmfr","osmde","osmbre","osmoci","osmeus","osmbot","ocm","otm","chm","ggm","subdomains","ggmst","defmap","indexOf","navigator","doNotTrack","grp","featureGroup","createMarkers","data","hasOwnProperty","options","browser","nb","Object","keys","map","layers","scrollWheelZoom","doubleRightClickZoom","document","querySelector","classList","add","maxpts","setView","fitBounds","getBounds","getZoom","setZoom","Control","Bigmap","extend","position","onAdd","DomUtil","create","link","href","_map","DomEvent","disableClickPropagation","on","action","ev","btn","stop","detail","getContainer","div","contains","remove","scrollIntoView","invalidateSize","addControl","control","scale","imperial","addTo","mkr","mkrs","getAttribute","slice","getElement","goToDetailFromMarker","target","move","geolocation","parent","getElementById","geoloc","text","textContent","getCurrentPosition","formAjax","coords","latitude","longitude","id","marker","lat","lng","title","shadowUrl","shadowRetinaUrl","shadowSize","shadowAnchor","superId","marklat","marklng","icon","iconUrl","Icon","Default","_getIconUrl","replace","iconSize","iconAnchor","className","form","xhr","XMLHttpRequest","loader","serialize","innerHTML","activeElement","blur","open","setRequestHeader","onreadystatechange","subelem","json","readyState","status","JSON","parse","responseText","maplist","items","country","toUpperCase","removeAttribute","checked","setAttribute","postcode","value","city","clearLayers","reset","getLatLng","error","location","reload","alert","e","send","Array","elements","nodeName","push","encodeURIComponent","join","rect","already","css","scrollHeight","offsetHeight","innerWidth","scrollTop","offsetTop","getBoundingClientRect","top","bottom","innerHeight","goToMarkerFromDetail","active","querySelectorAll","showSelect","updatePostcode","tel","addEventListener","bind"],"mappings":"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"}