/*!
 * Copyright 2019-2023 | Fabrice Creuzot <fabrice~cellublue~com>
 * Copyright 2019-2023 | MickaÃ«l Vang <mickael~cellublue~com>
 * https://github.com/kyrena/openmage-shippingmax
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t,o){for(t=t||window,o=0;o<this.length;o++)e.call(t,this[o],o,this)});var shippingmax=new function(){"use strict";this.showList=!1,this.showAll=!1,this.init=function(){console.info("shippingmax.map - hello");var e,t={},o='<a href="https://www.ign.fr/" target="_blank">IGN France</a>',a='<a href="https://www.openstreetmap.org/copyright" target="_blank">Open Street Map</a>',s='<a href="https://www.google.com/maps" target="_blank">Google</a>',i={ign:self.ignkey?L.tileLayer("https://wxs.ign.fr/"+self.ignkey+"/geoportail/wmts?&request=GetTile&service=WMTS&version=1.0.0&style=normal&tilematrixset=PM&format=image/jpeg&layer=GEOGRAPHICALGRIDSYSTEMS.MAPS&tilematrix={z}&tilerow={y}&tilecol={x}",{attribution:o,name:"IGN France",minZoom:4,maxZoom:18,tileSize:256,detectRetina:!0}):null,ignst:self.ignkey?L.tileLayer("https://wxs.ign.fr/"+self.ignkey+"/geoportail/wmts?&request=GetTile&service=WMTS&version=1.0.0&style=normal&tilematrixset=PM&format=image/jpeg&layer=ORTHOIMAGERY.ORTHOPHOTOS&tilematrix={z}&tilerow={y}&tilecol={x}",{attribution:o,name:"IGN Sat France",minZoom:4,maxZoom:18,tileSize:256,detectRetina:!0}):null,osm:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map",minZoom:4,maxZoom:19,detectRetina:!0}),osmfr:L.tileLayer("https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map France",minZoom:4,maxZoom:19,detectRetina:!0}),osmde:L.tileLayer("https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map Deutschland",minZoom:4,maxZoom:19,detectRetina:!0}),osmbre:L.tileLayer("https://tile.openstreetmap.bzh/br/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map Brezhoneg",minZoom:4,maxZoom:19,detectRetina:!0}),osmoci:L.tileLayer("https://tile.openstreetmap.bzh/oc/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map Occitan",minZoom:4,maxZoom:19,detectRetina:!0}),osmeus:L.tileLayer("https://tile.openstreetmap.bzh/eu/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map Euskara",minZoom:4,maxZoom:19,detectRetina:!0}),osmbot:L.tileLayer("https://{s}.tile.openstreetmap.fr/openriverboatmap/{z}/{x}/{y}.png",{attribution:a,name:"Open Street Map Boat",minZoom:4,maxZoom:19,detectRetina:!0}),ocm:L.tileLayer("https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",{attribution:'<a href="https://github.com/cyclosm/cyclosm-cartocss-style" target="_blank">CyclOSM</a>',name:"Open Cyclo Map",minZoom:4,maxZoom:19,detectRetina:!0}),otm:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{attribution:a,name:"Open Topo Map",minZoom:4,maxZoom:19,detectRetina:!0}),chm:L.tileLayer("https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg",{attribution:'<a href="https://www.swisstopo.admin.ch/" target="_blank">Swisstopo</a>',name:"Swiss Topo Map",minZoom:4,maxZoom:19,detectRetina:!0}),ggm:L.tileLayer("https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{subdomains:["mt0","mt1","mt2","mt3"],attribution:s,name:"Google Map",minZoom:4,maxZoom:19,detectRetina:!0}),ggmst:L.tileLayer("httpS://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:["mt0","mt1","mt2","mt3"],attribution:s,name:"Google Map Sat",minZoom:4,maxZoom:19,detectRetina:!0})};for(e in i)i.hasOwnProperty(e)&&i[e]&&i[e].options.name&&(i[e].options.attribution+=" "+self.browser,t[i[e].options.name]=i[e]);(!i[self.defmap]||"ggm"===self.defmap&&-1<["yes","1",1].indexOf(navigator.doNotTrack))&&(self.defmap="osm"),navigator.userAgent.match(/iPhone/i)&&this.qs("html").classList.add("iphone"),(e=self.parent.document.getElementById("shippingmaxBox"))&&(e.classList.add("hack"),this.qs("html").classList.add("popin")),self.grp=new L.featureGroup,self.map=L.map("map",{layers:[i[self.defmap],self.grp],scrollWheelZoom:!0,doubleRightClickZoom:!0}),L.control.layers(t).addTo(self.map),L.control.scale({imperial:!1}).addTo(self.map),this.createMarkers(),this.qs(".alone")||(L.Control.Bigmap=L.Control.extend({options:{position:"topleft"},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control");return this.link=L.DomUtil.create("a","leaflet-control-fullscreen-button leaflet-bar-part",t),this.link.href="",this._map=e,L.DomEvent.disableClickPropagation(this.link),L.DomEvent.on(this.link,"click",this.action,this),t},action:function(e){var t,o;L.DomEvent.stop(e),1==e.detail&&(e=this.getContainer().classList,o=(t=shippingmax).qs("body").classList,e.contains("leaflet-fullscreen-on")?(e.remove("leaflet-fullscreen-on"),o.remove("full-map"),this._map.invalidateSize(),(o=t.qs(".item.clicked, .item.selected"))&&(t.goToMarkerFromDetails({target:{nodeName:"fullscreenquit"}},o),t.scrollToDetails(o))):(e.add("leaflet-fullscreen-on"),o.add("full-map"),this._map.invalidateSize()))}}),self.map.addControl(new L.Control.Bigmap),L.Control.Hidemap=L.Control.extend({options:{position:"topright"},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-control-hidemap leaflet-bar leaflet-control close hide");return this.link=L.DomUtil.create("a","leaflet-control-hidemap-button leaflet-bar-part",t),this.link.href="",this._map=e,L.DomEvent.disableClickPropagation(this.link),L.DomEvent.on(this.link,"click",this.action,this),t},action:function(e){var t,o;L.DomEvent.stop(e),1==e.detail&&(e=this.getContainer().classList,o=(t=shippingmax).qs("body").classList,(e.contains("leaflet-hidemap-on")?(e.remove("leaflet-hidemap-on"),o.remove("hide-map"),t.qs(".leaflet-top.leaflet-right")):(e.add("leaflet-hidemap-on"),o.add("hide-map"),t.qs("body"))).appendChild(this.getContainer()))}}),self.map.addControl(new L.Control.Hidemap)),self!=self.parent&&"object"==typeof self.parent.shippingmax&&"function"==typeof self.parent.shippingmax.keyClose&&document.addEventListener("keydown",self.parent.shippingmax.keyClose)},this.createMarkers=function(){var e,t,o,a=Object.keys(self.data).length;if(self.grp.clearLayers(),0<a){for(o in this.qs("body").classList.remove("empty"),self.data)self.data.hasOwnProperty(o)&&(t=self.data[o],(t=L.marker([t.lat,t.lng],{title:t.name,shadowUrl:null,shadowRetinaUrl:null,shadowSize:null,shadowAnchor:null}).addTo(self.grp)).on("click",1<a?shippingmax.goToDetailsFromMarker:L.DomEvent.stop),t.on("dblclick",L.DomEvent.stop),t.htmlId=o,self.data[o].leaflet=t);0!=self.marklat&&0!=self.marklng&&L.marker([self.marklat,self.marklng],{icon:L.icon({iconUrl:L.Icon.Default.prototype._getIconUrl().replace("undefined","ic-user-map.svg"),iconSize:[26,40],iconAnchor:[13,25],shadowUrl:null,shadowRetinaUrl:null,shadowSize:null,shadowAnchor:null,className:"userpos"})}).addTo(self.grp),!(e=this.qs("#postcode"))||0<e.value.length?self.map.fitBounds(self.grp.getBounds(),{maxZoom:15}):self.map.setView([46.76,2.42],6),(e=this.qs(".item.selected"))&&((t=self.data[e.getAttribute("id").slice(2)].leaflet).getElement().classList.add("selected"),this.goToDetailsFromMarker({target:t,move:!1}))}else this.qs("body").classList.add("empty");return a},this.stopScrollFromFixed=function(e){for(var t=e.target;t.parentNode&&"BODY"!==t.nodeName;){if(t.classList.contains("leaflet-control-layers-scrollbar"))return;if(t.classList.contains("map")||t.classList.contains("top"))return e.preventDefault(),void e.stopPropagation();t=t.parentNode}},this.closeMap=function(){"function"==typeof self.parent.shippingmax.close?self.parent.shippingmax.close(!0):self.close()},this.qs=function(e){return document.querySelector(e)},this.askGeoloc=function(){var t,o;navigator.geolocation?(t=shippingmax,(o=document.getElementById("loader").classList).add("show"),navigator.geolocation.getCurrentPosition(function(e){t.submitFormAjax(t.qs("form.search"),e.coords.latitude,e.coords.longitude,!0)},function(e){o.remove("show"),console.warn(e)})):this.qs(".btn-geoloc").classList.add("hide")},this.submitFormAjax=function(e,t,o,a){var s,i,n=shippingmax,l=n.showAll,r=document.getElementById("loader").classList;if(document.activeElement.blur(),!0!==a&&r.contains("show"))return!1;try{return r.add("show"),i=new XMLHttpRequest,l?(n.showAll=!1,i.open("GET",e.action+"?isAjax=true",!0)):(s=n.serializeForm(e),"number"==typeof t&&"number"==typeof o&&(s+="&lat="+t+"&lng="+o+"&geoloc=1"),i.open("POST",-1<s.indexOf("id=")?e.action+"?isAjax=true&"+s:e.action+"?isAjax=true",!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded")),i.onreadystatechange=function(){var e,t,o,a;if(4===i.readyState&&(200===i.status||0===i.status))try{(o=JSON.parse(i.responseText)).status&&o.maplist?(self.scroll(0,0),n.qs("form.results").innerHTML=o.maplist,self.data=o.items,self.marklat=o.lat,self.marklng=o.lng,o.country&&(e=n.qs('.country-choice input[value="'+o.country.toUpperCase()+'"]'))&&((t=n.qs(".country-choice input[checked]"))&&t.removeAttribute("checked"),(t=n.qs(".country-choice input:checked"))&&(t.checked=!1),e.checked=!0,e.setAttribute("checked","checked")),(l||o.postcode)&&(document.getElementById("postcode").value=o.postcode||""),(l||o.city)&&(document.getElementById("city").value=o.city||""),n.createMarkers(),r.remove("show")):o.status?"function"==typeof self.parent.shippingmax.show?self.parent.shippingmax.show(o):(n.resetMarkers(!0),(a=self.data[o.id].leaflet).getElement().classList.add("selected"),self.map.setView(a.getLatLng(),15),document.getElementById("pt"+o.id).classList.add("selected","clicked"),r.remove("show")):o.error?"refresh"===o.error?self.location.reload():(alert(o.error),r.remove("show")):(alert(o),r.remove("show"))}catch(e){console.error(e,i.responseText),self.location.reload()}},i.send(s),!1}catch(e){console.error(e),r.remove("show")}return!0},this.serializeForm=function(e){var t=[];return Array.prototype.forEach.call(e.elements,function(e){"INPUT"===e.nodeName?-1<["checkbox","radio"].indexOf(e.getAttribute("type"))&&!e.checked||t.push(e.name+"="+encodeURIComponent(e.value)):"SELECT"===e.nodeName&&t.push(e.name+"="+encodeURIComponent(e.value))}),t.join("&")},this.goToDetailsFromMarker=function(e){var t,o,a,s;"BUTTON"===e.target.nodeName||document.activeElement&&"BUTTON"===document.activeElement.nodeName||(t=shippingmax,s=(a=(o=e.target).getElement().classList).contains("clicked"),t.resetMarkers(),s?a.remove("clicked"):(s=document.getElementById("pt"+o.htmlId),!1!==e.move&&(a.add("clicked"),s.classList.add("clicked"),self.map.setView(o.getLatLng())),t.scrollToDetails(s)))},this.goToMarkerFromDetails=function(e,t){var o,a;"BUTTON"===e.target.nodeName||document.activeElement&&"BUTTON"===document.activeElement.nodeName||(a=(o=t.classList).contains("clicked"),this.resetMarkers(),a&&!o.contains("selected")&&"fullscreenquit"!==e.target.nodeName?o.remove("clicked"):(o.add("clicked"),(a=self.data[t.getAttribute("id").slice(2)].leaflet).getElement().classList.add("clicked"),self.map.setView(a.getLatLng(),15)))},this.scrollToDetails=function(e){var t;this.qs("html.iphone.popin")?(t=this.qs(".map").getBoundingClientRect().bottom+5,this.qs(".results-list").setAttribute("style","margin:-"+t+"px 0 "+t+"px;"),e.scrollIntoView({block:"start"}),this.qs(".results-list").removeAttribute("style")):self.scroll(0,self.innerWidth<768?e.offsetTop-parseInt(self.getComputedStyle(this.qs(".results")).paddingTop)-5:e.offsetTop-self.innerHeight/2+this.qs(".top").offsetHeight/2+e.offsetHeight/2)},this.resetMarkers=function(t){document.querySelectorAll(".clicked, .selected").forEach(function(e){e.classList.remove("clicked",t?"selected":"nothing")})},this.updateZipFromCountry=function(e){document.getElementById("postcode").setAttribute("type",self.tel.indexOf(e.value)<0?"text":"tel"),"MC"==e.value&&(document.getElementById("postcode").value="98000",document.getElementById("city").value="Monaco")},this.showSelect=function(e){e=!1!==e&&(this.showList=!this.showList)?"add":"remove",this.qs(".search").classList[e]("country-select"),this.showList="add"===e}};function _AutofillCallbackHandler(){}function _pcmBridgeCallbackHandler(){}"function"==typeof self.addEventListener&&(self.addEventListener("load",shippingmax.init.bind(shippingmax)),self.addEventListener("DOMMouseScroll",shippingmax.stopScrollFromFixed,{passive:!1}),self.addEventListener("mousewheel",shippingmax.stopScrollFromFixed,{passive:!1}),self.addEventListener("touchmove",shippingmax.stopScrollFromFixed,{passive:!1}));var PaymentAutofillConfig={};
//# sourceMappingURL=map.min.js.map